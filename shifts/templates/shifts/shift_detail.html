<!-- /workspace/shiftwise/shifts/templates/shifts/shift_detail.html -->

{% extends 'base.html' %}
{% load custom_tags %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}Shift Detail - {{ shift.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">{{ shift.name }} Details</h3>
        </div>
        <div class="card-body">
            <!-- Shift Details -->
            <p><strong>Date:</strong> {{ shift.shift_date|date:"D, d M Y" }}</p>
            <p><strong>Start Time:</strong> {{ shift.start_time }}</p>
            <p><strong>End Time:</strong> {{ shift.end_time }}</p>
            <p><strong>Duration:</strong> {{ shift.duration }} hours</p>
            <p><strong>Capacity:</strong> {{ shift.capacity }}</p>
            <p><strong>Available Slots:</strong> {{ shift.available_slots }}</p>
            <p><strong>Agency:</strong> {{ shift.agency.name }}</p>
            <p><strong>Address:</strong> {{ shift.address_line1 }}, {{ shift.city }}, {{ shift.county }}, {{ shift.country }}, {{ shift.postcode }}</p>
            <p><strong>Shift Type:</strong> {{ shift.get_shift_type_display }}</p>
            <p><strong>Hourly Rate:</strong> Â£{{ shift.hourly_rate }}</p>
            <p><strong>Notes:</strong> {{ shift.notes }}</p>
            <p><strong>Status:</strong> {{ shift.get_status_display }}</p>
            
            <!-- Display Distance -->
            <p><strong>Distance from Your Location:</strong> 
                {% if distance_to_shift %}
                    {{ distance_to_shift|floatformat:2 }} miles
                {% else %}
                    <span class="text-muted">N/A</span>
                {% endif %}
            </p>
            
            {% if shift.is_completed %}
                <p><strong>Completed At:</strong> {{ shift.completion_time }}</p>
                {% if shift.signature %}
                    <p><strong>Signature:</strong></p>
                    <img src="{{ shift.signature.url }}" alt="Signature" class="img-fluid">
                {% endif %}
                {% if shift.completion_latitude and shift.completion_longitude %}
                    <p><strong>Completion Location:</strong> {{ shift.completion_latitude }}, {{ shift.completion_longitude }}</p>
                    <!-- Calculate and display the distance -->
                    {% get_distance shift shift.completion_latitude shift.completion_longitude as distance %}
                    <p><strong>Distance from Shift Location:</strong> {{ distance|floatformat:2 }} miles</p>
                {% endif %}
            {% endif %}
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            {% if user.is_authenticated %}
                <div>
                    {% if can_edit %}
                        <a href="{% url 'shifts:shift_update' shift.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Edit Shift
                        </a>
                        <a href="{% url 'shifts:shift_delete' shift.pk %}" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> Delete Shift
                        </a>
                    {% endif %}
                    {% if can_book %}
                        <a href="{% url 'shifts:book_shift' shift.id %}" class="btn btn-success">
                            <i class="fas fa-bookmark"></i> Book Shift
                        </a>
                    {% elif can_unbook %}
                        <a href="{% url 'shifts:unbook_shift' shift.id %}" class="btn btn-warning" onclick="return confirm('Are you sure you want to unbook this shift?');">
                            <i class="fas fa-undo"></i> Unbook Shift
                        </a>
                    {% elif shift.is_full %}
                        <span class="text-muted">Shift is Full</span>
                    {% endif %}
                    <a href="{% url 'shifts:shift_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Shifts
                    </a>
                    {% if can_edit and not shift.is_completed %}
                        <!-- Button to trigger Complete Shift Modal -->
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#completeShiftModal">
                            <i class="fas fa-check-circle"></i> Complete Shift
                        </button>
                    {% endif %}
                </div>
                <div>
                    <a href="{% url 'shifts:download_timesheet' %}" class="btn btn-outline-success">
                        <i class="fas fa-download"></i> Download Timesheet
                    </a>
                </div>
            {% else %}
                <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login to Book
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Assign Workers Section -->
    {% if can_assign_workers %}
        <h4 class="mt-4">Assign Workers</h4>
        <form method="post" action="{% url 'shifts:assign_worker' shift.id %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="workerSelect">Select Worker:</label>
                <select name="worker_id" id="workerSelect" class="form-control" required>
                    <option value="" disabled selected>Choose a worker</option>
                    {% for worker in available_workers %}
                        <option value="{{ worker.id }}">{{ worker.get_full_name }} ({{ worker.email }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success">Assign Worker</button>
        </form>
    {% endif %}

    <!-- Assigned Workers List -->
    <h4 class="mt-4">Assigned Workers</h4>
    <ul class="list-group">
        {% for assignment in assigned_workers %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ assignment.worker.get_full_name }} ({{ assignment.get_role_display }})
                {% if can_assign_workers %}
                    <form method="post" action="{% url 'shifts:unassign_worker' shift.id assignment.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to unassign this worker?');">
                            <i class="fas fa-user-minus"></i> Unassign
                        </button>
                    </form>
                {% endif %}
            </li>
        {% empty %}
            <li class="list-group-item text-muted">No workers assigned to this shift.</li>
        {% endfor %}
    </ul>
</div>

<!-- Include the Shift Completion Modal if applicable -->
{% if can_edit and not shift.is_completed %}
    {% include 'shifts/shift_complete_modal.html' %}
{% endif %}
{% endblock %}

{% block extra_js %}
    <!-- Include SignaturePad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- Include jQuery and Bootstrap JS if not already included -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- Include the Shift Completion Modal JavaScript -->
    <script src="{% static 'shifts/js/shift_complete_modal.js' %}"></script>
    <!-- Include the General Scripts -->
    <script src="{% static 'js/scripts.js' %}"></script>
{% endblock %}